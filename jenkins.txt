pipeline {
    agent any

    environment {
        // Defining a virtual environment path
        BASE_VERSION = "1.0"
    }

    stages {
        stage('Checkout') {
            steps {
                // Replace this with your specific repo URL
                git branch: 'master', 
                    url: 'https://github.com/krufusraj/devops_practice'
            }
        }
        
        stage('List'){
            steps{
                sh 'ls'
            }
        }
        
        stage('Docker Build') {
            steps {
                sh "docker build -t myapp-jenkins:${env.BASE_VERSION}.${env.BUILD_NUMBER} ."
            }
        }
        stage('Update and Push') {
            steps {
                script {
                    def yaml = readYaml file: 'k8/myapp/values.yaml'
                    yaml.image.tag = "${env.BASE_VERSION}.${env.BUILD_NUMBER}"
                    writeYaml file: 'values.yaml', data: yaml, overwrite: true
                }
                
                // Push the change back to GitHub so ArgoCD notices
                sh """
                    git add values.yaml
                    git commit -m "chore: updated image tag to ${env.BASE_VERSION}.${env.BUILD_NUMBER}"
                    git push origin master
                """
            }
        }
    }

}